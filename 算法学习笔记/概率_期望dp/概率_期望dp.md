# 期望

## 经典题

### 例1

在一棵$n$个点的树上游走，求从根走到$x$的期望步数。

---



对每条边$(u,v)$记录从$u$走到$v$的期望步数。$S_u$表示$u$的儿子数（有根树）
$$
\begin{aligned}
E(u,v)&=\frac{1}{S_u+1}+\sum_{(u\rightarrow v')\in E,v'\neq v} (1+E(v',u)+E(u,v))\\
&=S_u+1+\sum_{(u\rightarrow v')\in E,v'\neq v} E(v',u)
\end{aligned}
$$

先向上算,在向下算.

把$v$当作$u$的父节点，那么$v'$一定是$u$的子节点。这就是一个树形 DP。算完到 root 后再从根到子节点算一下向下走的边的期望。

### 例2

构造一张 200 个点的无向图, 使得上面从$S$走到$T$的随机游走期望步数大于等于$1000000$步。

---

简单的链和完全图都不行, 考虑组合起来, 一个n=100个点得完全图 从某一个$u$点连出一条链,则$u$沿着链走一步的期望步数为
$$
E(u)=\frac{1}{n}+\frac{n-1}{n}(1+n-1+E(u))
$$
故
$$
Eu=1+n(n-1)
$$
链上有递推关系
$$
E=\frac{1}{2}+\frac{1}{2}(1+E'+E)\Rightarrow E=E'+2
$$

$$
\sum_{k=0}^{n} E_k=\frac{(E_0+E_0+2n)(n+1)}{2}=(n^2+1)(n+1)>1000000
$$

### 例3

随机一个长度为$n$个排列$p$，求$\langle p_j\rang_{j=1}^{i}$中$p_i$是最大的数的个数（即前缀最大值的个数）的期望。

---

$$
E(S)=\sum_{i=1}^{n}E(x_i)=H_n
$$

### 例4

随机一个长度为$n$个排列$p$，求$\langle p_j\rang_{j=1}^{i}$中$p_i$是最大的数的个数（即前缀最大值的个数）的平方的期望。

---

$$
E(S)=E\left( \left(\sum_{i=1}^{n}x_i \right)^2 \right)=\sum_{i\neq j} E(x_ix_j) +\sum_{i=1}^{n}E(x_i^2)
$$

由于$x_i\in\{0,1\}$ 故只用考虑前面一项

不妨认为有$i<j$ $P(i|j)=\frac{1}{i}$,故这两个事件相互独立.

因此答案为
$$
\sum_{i\neq j} \frac{1}{ij} +H_n
$$

### 例5

随机一个长度为$n$的排列$p$，求它包含$\langle w_i\rang_{i=1}^{m}$作为连续子序列的概率。

---

显然有
$$
\frac{(n-m+1)!}{n!}
$$

$$
x_j = 
\begin{cases}
1, &\text{若在位置 }j\text{ 上出现 }(w_1,\dots,w_m)\,,\\
0, &\text{否则\,.}
\end{cases}
\quad j=1,2,\dots,n-m+1\,.
$$

$$
T=\sum_{j=1}^{n-m+1}E(x_j)=(n-m+1)\frac{1}{n(n-1)\cdots(n-m+1)}=\frac{(n-m+1)!}{n!}
$$

### 例6

有$n$堆石头，第$i$堆个数为$a_i$。每次随机选一个石头然后把那一整堆都扔了，求第1堆石头期望第几次被扔。

---

设随机变量$x_i$表示第$i$堆石头是第几个被拿走的，显然我们有
$$
x_1=1+\sum_{i=2}^{n}[x_i<x_1]
$$

$$
E(x_1)=1+\sum_{i=2}^{n} P(x_i<x_1)
$$

而第$i$堆先被拿走的概率为
$$
P(i被拿走|1或i被拿走)=\frac{a_i}{a_1+a_i}
$$
故
$$
E(x_i)=1+\sum_{i=2}^{n}\frac{a_i}{a_i+a_1}
$$

### 例7

随机一个长度为$n$的 01 串，每个位置是1的概率是$p$，定义$S$是每段连续的1的长度的平方之和，求$S$的期望。

---

令$x_i$表示$\lang s_j \rang_{j=1}^{i}$中所有为1的段的长度的平方之和，因此$E(S)=E(x_n)$。再令$y_i$表示$\lang s_j \rang_{j=1}^{i}$中最后一段1的长度。有
$$
y_i=\begin{cases}
0 \quad &s_i=0\\
y_{i-1}+1\quad &s_i=1
\end{cases}
$$

$$
x_i=\begin{cases}
x_{i-1} \quad &s_i=0\\
x_{i-1}-y_{i-1}^2+(y_{i-1}+1)^2=x_{i-1}+2y_{i-1}+1 \quad &s_i=1
\end{cases}
$$

那么有
$$
E(y_i)=(E(y_{i-1})+1)p
$$

$$
\begin{aligned}
E(x_i)&=p(E(x_{i-1})+2E(y_{i-1})+1)+(1-p)E(x_{i-1})\\
&=E(x_{i-1})+2pE(y_{i-1})+p	
\end{aligned}
$$

### 例8

给一个序列$1,2,⋯,n$，每次随机删除一个元素, 问$i$和$j$在过程中相邻的概率。

---

删除顺序对应一个排列
$$
P=\frac{(j-i-1)!2!}{(j-i+1)!}=\frac{1}{\binom{j-i+1}{2}}
$$

### 例9

给定一棵树，将他的边随机一个顺序后依次插入，求$u,v$期望什什么时候连通。

---

假设其路径长度为k ，枚举最后一条边插入的位置
$$
E=\frac{\sum_{i=k}^{n-1}i\binom{i-1}{k-1}k!(n-1-k)! }{(n-1)!}
$$

### 例10

给$1,2,⋯,n$这$n$个数，每次随机选择一个还在的数，删掉他的所有约数。求期望几次删完。

---

直接做的话，每一次删掉的数的个数不方便统计，不妨换一下思路。我们考虑这个问题：
给$1,2,⋯,n$这$n$个数，初始时每个数都是白的。每次随机选择一个还在的数，如果它是黑的就删掉它，否则就把它的约数标黑再删掉它。求期望删掉几个白色的数。

定义随机变量$x_i$
$$
x_i=\begin{cases}
1\quad &\text{white}\\
0\quad &\text{black}
\end{cases}
$$

$$
E(S)=\sum_{i=1}^{n}E(x_i)
$$

而其为白色 即为 在其倍数中，它第一个被选择
$$
E(S)=\sum_{i=1}^{n} \frac{1}{\lfloor \frac{n}{i} \rfloor}
$$

### 例11

给定$n$个硬币，第$i$个硬币的价值为$w_i$，每次随机取走一个硬币，获得的收益是左右两个硬币的价值的乘积，求期望总价值。

---

定义随机变量$x_{i,j}$表示
$$
x_{i,j}=\begin{cases}
1\quad & \text{i,j was chosen}\\
0\quad & \text{i,j wsa not chosen}
\end{cases}
$$

$$
P(x_{i,j}=1)=\frac{1}{\binom{j-i+1}{2}}
$$

$$
E(S)=\sum_{i<j} \frac{w_iw_j}{\binom{j-i+1}{2}}
$$



### 例12

有$N$个数$\lang a_i \rang_{i=1}^{n}$，每次等概率选出两个数，然后合并成一个新的数放回来，得到的收益是新的数的值，求总收益的期望。

---

定义随机变量$x_i$表示$a_i$的贡献次数，在n个数中选择两个数其中包含$a_i$的概率是$1-\frac{\binom{n-1}{2}}{\binom{n}{2}}=\frac{2}{n}$
$$
E(x_i)=\sum_{j=1}^{n-1}\frac{2}{n+1-j}
$$

$$
E(S)=\sum_{i=1}^{n}a_i\sum_{j=1}^{n-1}\frac{2}{n+1-j}
$$

### 例13

给定一个数列$\lang w_i \rang_{i=1}^{n}$，随机一个排列$H$，如果$H_i$比$H_{i-1}$和$H_{i+1}$都大，就获得$w_i$的收益，求期望收益。

---

定义随机变量$x_i$
$$
x_i=\begin{cases}
1 \quad h_i>\max(h_{i-1},h_{i+1})\\
0 \quad \text{Otherwise}
\end{cases}
$$
求$P(x_i=1)$ 在中间为$\frac{1}{3}$, 两边为$\frac{1}{2}$

### 例14

给出一棵树, 一开始每个点都是白的, 每次选一个白点将他子树里所有点染黑，求期望几次染黑整个树。

---

问题转化为每个点在它到根的路径上的点集中最先被删的概率，答案为
$$
E(S)=\sum_{i=1}^{n} \frac{1}{\text{dep}_x}
$$

## 总结

需要使用期望的性质解决的问题，通常都可以设出随机变量，并利用期望转概率、前缀和（容斥）、组合计数等技巧去解决。在解题的过程中也要灵活应用，重在理解题目的含义，发掘一些性质。

## 练习

